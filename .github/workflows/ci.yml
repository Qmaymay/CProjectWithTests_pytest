name: Calculator CI

on:
  push:
    branches: [ main, master, refactor/project-structure ]
  pull_request:
    branches: [ main, master ]

jobs:
  windows-msvc:
    name: Windows MSVC
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Create build directory
        run: mkdir build

      - name: Configure with CMake (MSVC)
        run: |
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64

      - name: Build project (MSVC)
        run: |
          cd build
          cmake --build . --config Release

      - name: Test executable (MSVC)
        run: |
          cd build/lib
          if (Test-Path "calculator_app_msvc.exe") {
            .\calculator_app_msvc.exe
            echo "✅ MSVC executable test passed"
          }

      - name: Run Python tests (MSVC)
        shell: pwsh
        run: |
          # 彻底设置UTF-8编码环境
          $OutputEncoding = [System.Text.Encoding]::UTF8
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          [Console]::InputEncoding = [System.Text.Encoding]::UTF8
          $env:PYTHONIOENCODING = "utf-8"
          $env:PYTHONUTF8 = "1"
          $env:LANG = "en_US.UTF-8"
          
          cd calculator_tests
          python main.py

      - name: List generated files (MSVC)
        run: |
          cd build/lib
          dir *.exe *.dll

  windows-mingw:
    name: Windows MinGW
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install MinGW
        shell: cmd
        run: |
          curl -L -o mingw.7z "https://github.com/niXman/mingw-builds-binaries/releases/download/15.2.0-rt_v13-rev0/x86_64-15.2.0-release-posix-seh-ucrt-rt_v13-rev0.7z"
          7z x mingw.7z -oC:\mingw
          echo C:\mingw\mingw64\bin>>%GITHUB_PATH%

      - name: Create build directory
        run: mkdir build

      - name: Configure with CMake (MinGW)
        run: |
          cd build
          cmake .. -G "MinGW Makefiles"

      - name: Build project (MinGW)
        run: |
          cd build
          cmake --build .

      - name: Test executable (MinGW)
        run: |
          cd build/lib
          if (Test-Path "calculator_app.exe") {
            .\calculator_app.exe
            echo "✅ MinGW executable test passed"
          }

      - name: Run Python tests (MinGW)
        shell: pwsh
        run: |
          # 彻底设置UTF-8编码环境
          $OutputEncoding = [System.Text.Encoding]::UTF8
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          [Console]::InputEncoding = [System.Text.Encoding]::UTF8
          $env:PYTHONIOENCODING = "utf-8"
          $env:PYTHONUTF8 = "1"
          $env:LANG = "en_US.UTF-8"
          
          cd calculator_tests
          python main.py

  linux-gcc:
    name: Linux GCC
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake python3 python3-pip

      - name: Create build directory
        run: mkdir build

      - name: Configure with CMake (GCC)
        run: |
          cd build
          cmake .. -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=Release

      - name: Build project (GCC)
        run: |
          cd build
          cmake --build .

      - name: Test executable (GCC)
        run: |
          cd build/lib
          if [ -f "calculator_app" ]; then
            ./calculator_app
            echo "✅ GCC executable test passed"
          fi

      - name: Run Python tests (GCC)
        run: |
          cd calculator_tests
          PYTHONIOENCODING=utf-8 python3 main.py

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [windows-msvc, windows-mingw, linux-gcc]
    if: always()

    steps:
      - name: Display test results
        run: |
          echo "=== 完整测试结果 ==="
          echo "Windows MSVC: ${{ needs.windows-msvc.result }}"
          echo "Windows MinGW: ${{ needs.windows-mingw.result }}"
          echo "Linux GCC: ${{ needs.linux-gcc.result }}"
          echo "===================="
          
          if [[ "${{ needs.windows-msvc.result }}" == "success" && 
                "${{ needs.windows-mingw.result }}" == "success" && 
                "${{ needs.linux-gcc.result }}" == "success" ]]; then
            echo "🎉 所有平台测试通过！"
            exit 0
          else
            echo "❌ 部分测试失败"
            exit 1
          fi